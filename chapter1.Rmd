---
title: "Portfolio Theory"
author: "Matt Brigida"
date: "November 27, 2015"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!---
Note, much of the R code in this text was written long ago, when I wrote even worse R code than I do now.  The code works, but it is inefficient and ugly.  I decided not to rewrite it however, feeling it more important to get the text out and into students' hands.  If you can improve the code, please feel free.  Pull requests are always welcome.
-->


# Introduction

Despite 'theory' in the title, this course will teach you how to construct portfolios in the real world.  We'll generally introduce a topic, learn the theoretical underpinnings, and then try to apply the topic to real data.  Some of the most interesting topics in this course will be on the implementation of the theories we have learned.  

Through this course the student will gain a working knowledge of what we mean by the term *risk* in finance.  There will be differing measures of risk depending on the assumptions you make about the world.  Then, for a given set of assumptions, risk will directly determine portfolio allocations.  We'll also cover an extension of this, where the resulting portfolio allocations will imply an equilibrium expected return for each asset (the CAPM).  An apt alternative title for this course would be 'Risk and its Implications'. 

### Arithmetic versus Geometric Returns

Given a time series of returns, we can calculate arithmetic and geometric average returns.  Each type of average return (arithmetic vs geometric) is trying to answer a different question.

#### Arithmetic average:

You may recall, if we are given a discrete probability density function which describes returns, we can calculate the expected, or average, return as $E(r) = \sum_{s=1}^N{p(s)r(s)}$ where $s$ denotes the state of the world, and $p(s)$ and $r(s)$ is the probability of that state, and the return in that state, respectively.

When we switch to a time series of historical returns, we assign each return observation as equally likely.  So if there are $T$ returns, then each has probability $\frac{1}{T}$.  Therefore, the arithmetic average return is:

$\bar{r} = \frac{1}{T}\sum_{t = 1}^T{r_t}$

The arithmetic average return may be interpreted as the return we expect if we were to choose one year's return at random.  Also, if we assume the future is like the past, then we can say, given no other information, it is the return we expect in any given future year.   

#### Geometric average:

The geometric average (denote by $GA$) return is:

$GA = \left(\prod_{t=1}^T(1 + r_t)\right)^{\frac{1}{T}} - 1$

In other words, add 1 to each return, multiply all the returns together, and take the $T$th root of the product of the returns.  Then subtract 1, and you have the geometric average.  The geometric average can be interpreted as the average return per period you expect to earn over a set period.  

As a note, the geometric average is always less than or equal to the arithmetic average. The only case where the averages are equal is of all the returns being averaged are equal.  Can you prove this?  


### A Brief Note on Ergodicity 

You may point out that what we have just done is not really compelling evidence. We have looked at an historical sample of size 1, and implied that this must hold.  In fact, to make any sort of statement about the empirical relationship between risk and return we would need to sample many times from all possible histories, and then average over these histories.  Of course, we can only ever observe one history---an important distinction from empirical results in disciplines such as physics and chemistry.

However, if the time series are ergodic, then averaging over time gives the same result as averaging over possible histories. The very interested student can see Hamilton's *Time Series Analysis*.  

Later, however we'll also see theories which imply a similar risk/return relationship. This will lend credence to these earlier empirical observations.  

### Real vs Nominal Rates

In what follows we'll be mainly converned with nominal rates of return.  The *nominal* rate is the change in the amount of currency (US dollars) you have. Conversely, the *real* rate of return is the change in your purchasing power---the amount of stuff you can buy.  Since currency is only (1) a medium of exchange (for stuff) and a (2) store of value, we relly only care about our real rate of return.

However, we can never really know what our real return was, because to calculate it we need the nominal rate and inflation.  We know the nominal rate with certainty, however we can only estimate what inflation was (or will be).  Therefore, there is some uncertainty as to the value of the real rate.  Below is a brief table highlighting some salient differences between the real and nominal rates. Note, $r$ is the real rate, $R$ the nominal, and $i$ denotes inflation. 

|        | Real Rate | Nominal Rate |
|--------|-----------|--------------|
| Means  | Change in what you can buy| Change in dollars |
| Certainty | We only estimate the real rate | We can observe the nominal rate |
| Solved for: | $r = \frac{R -i}{1 + i}$ | $R = r + E(i)$ |
| Taxes | Taxes are not paid on the real rate | Taxes are paid on the nominal rate |
| As an investor | You are concerned with a high (risk-adjusted) after-tax real rate of return | Only relevant as it affects real rate |
|    |     |      |




### Risk Premia

An assets risk premium is the reward you expect to earn for bearing risk.  We can express the risk premium as $E(r) - r_f$ where $E(r)$ is the expected return on a risky asset, and $r_f$ is the risk free rate.  Understanding risk premia will be a central part of this course.

### The Standard Deviation and Variance







### The Sharpe Ratio

The Sharpe Ratio is the ratio of an investment's reward to is volatility. In other words, it is what you receive in excess of the risk-free rate scaled by the risk you have to take to get that return.

$Sharpe\ Ratio=\frac{Risk\ Premium}{Volatility}$

where the volatility is defined as the standard deviation of excess returns.

<!---insert app which will calculate historical sharpe ratios?-->

### How good of an approximation is the normal distribution?

The idea of the application below is that in what follows we'll assume that stock behaves according to the normal distribution (red dotted line).  The empirical distribution is how the stock actually behaved over the interval in which we calculated the stock's parameters (mean and standard deviation).

Try different stocks and start dates.  You'll generally find small stocks over short time intervals have very non-normal empirical distributions.  However, often large stocks over long periods will have non-normal distributions as well.  The question is, given this evidence, why do we assume the normal distribution, and is it incorrect to do so?  

```{r comparetoNormal, echo=FALSE}
## compare normal and empirical distributions 
#{{{
inputPanel(
  textInput("ticker1", "Stock Ticker", value = "GE"),
  dateInput("startDate1", "Start Date", value = "2015-01-01")
)
```
```{r, echo = FALSE}
renderPlot({
library(tseries)
library(quantmod)
  
    x <- get.hist.quote(input$ticker1, start = input$startDate1, quote = "Close")
    x <- xts(x)
    r <<- Delt(x, type = 'log')[-1]

    plot(density(r), main = "Normal versus Empirical Distribution", lty = 1, 
        col = 1, lwd = 2, xlab = "Log-Returns in %/100") #, sub = "Matthew Brigida; Clarion UofP")

    lines(density(rnorm(5e+05, mean = mean(r), sd = sd(r))), lty = 4, col = 2, 
        lwd = 2)

    legend("topright", c("Stock Return Density", "Normal Density"), col = c(1, 2), 
           lty = c(1, 4), lwd = c(2, 2))
})
```
```{r, echo = FALSE}
    renderPrint({
        null <- input$ticker1
        null <- input$startDate1
    cat("The sample skewness is", skewness(r), "\n")
    cat("For a t-statistic of", skewness(r)/(sqrt(6/length(r))), "\n")
    p1 <- 2 * (1 - pt(abs(skewness(r)/(sqrt(6/length(r)))), length(r) - 1))
    cat("And a p-value of", p1, "\n")
    cat("So we", ifelse(p1 < 0.05, "reject the null, and find the distribution is skewed.", 
        "do not reject the null, the distribution is symmetric."), "\n")
    cat("\n")
    
    cat("The sample excess kurtosis is", kurtosis(r)[1], "\n")
    cat("For a t-statistic of", kurtosis(r)/(sqrt(24/length(r))), "\n")
    p2 <- 2 * (1 - pt(abs(kurtosis(r)/(sqrt(24/length(r)))), length(r) - 1))
    cat("And a p-value of", p2, "\n")
    cat("So we", ifelse(p2 < 0.05, "reject the null, and find the distribution has fat tails.", 
        "do not reject the null, the distribution does not have fat tails."), 
        "\n")
                                        cat("\n")
        
})    
#}}}
```


## Deviations from Normality

### Skewness

### Kurtosis


## Risk and Return Over our History

Most texts in portfolio theory contain a summary of the rate of return on different asset classes over time.  This is to show you different assets have different characteristics---on the whole assets with greater risk have higher long-term returns.  We'll be no different. However, take care to note the point of this exercise is simply to get an intuitive feel of the idea that taking more risk grants a higher return.

Further, it can't be mentioned enough that ultimately it will be the covariance (correlation) between asset which will greatly affect the weight of the asset in our portfolio, and the expected return on that asset.  So take care to not how one asset behaves relative to another.  

Note, throughout this text we'll generally quote returns on an annual basis.  This is important, because to compare returns between any two investments, we must look at the returns over the same length of time.  Beware anyone who quotes you their return over (particularly) longer peiods than a year, "I doubled my money in 10 years".  This is somewhat decieving because a 100\% return in 10 years is only 7.18\% per year.

```{r riskReturnHistory, echo=FALSE, message = FALSE, warning = FALSE, cache = FALSE, eval = FALSE}
library(shiny)
library(dygraphs)
library(quantmod)
renderPlot({

    tenYr <- getSymbols('GS10', src = 'FRED')
    threeMonth <- getSymbols('TB3MS', src = 'FRED')
    moodysAAA <- getSymbols('AAA', src = 'FRED')
    moodysBAA <- getSymbols('BAA', src = 'FRED')
    djiaTo1968 <- getSymbols('M1109BUSM293NNBR', src = 'FRED')
    


})
```



# Risk Measures

## Value at Risk (VaR)


### Interactive VaR Application

These functions output VaR estimates using both the historical empirical density function and a normal density (with a mean and standard deviation based on the historical data).  

#### Using a 5\% VaR

```{r var5, echo=FALSE}
inputPanel(
    textInput("tickerVar5", "Input a Stock Ticker", "XOM"),
    dateInput("startDateVar5", "Start date:", value = "2015-01-01")
)

renderPrint({
    library(fBasics)
    library(tseries)
    x <- get.hist.quote(input$tickerVar5, start = input$startDateVar5, quote="Close")
x <- ts(x)
r <- log(x[2:(length(x))]/x[1:(length(x)-1)])
emp.var <- quantile(r, probs=0.05)*1000000
cat("The empirical VaR is", emp.var, "\n")
cat("The VaR assuming a normal distribution is", quantile(rnorm(500000, mean=mean(r), sd=sd(r)), probs=0.05)*1000000, "\n")
})
```

#### Using a 1\% VaR

```{r var1, echo = FALSE}
inputPanel(
    textInput("tickerVar1", "Input a Stock Ticker", "XOM"),
    dateInput("startDateVar1", "Start date:", value = "2015-01-01")
)

renderPrint({
    library(fBasics)
    library(tseries)
    x <- get.hist.quote(input$tickerVar1, start = input$startDateVar1, quote="Close")
x <- ts(x)
r <- log(x[2:(length(x))]/x[1:(length(x)-1)])
emp.var <- quantile(r, probs=0.01)*1000000
cat("The empirical VaR is", emp.var, "\n")
cat("The VaR assuming a normal distribution is", quantile(rnorm(500000, mean=mean(r), sd=sd(r)), probs=0.01)*1000000, "\n")
})
```







## Contitional Tail Expectation
